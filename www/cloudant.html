<!DOCTYPE html>
<html>
  <head>
    <title>Cloudant-Test</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Tariq Hamid" />
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
    <script type='text/javascript' src='script/couch/couch.js'></script>
    <script type='text/javascript' src='script/couch/sha1.js'></script>
  </head>
  <body>
    <div id="couchdb-demo" style="border: solid pink;background-color: #ff9;">
      <div class="comment">
        Cloudant
      </div>
      <form onsubmit="submitToCloudant(this);return false;" autocomplete="on">
        <label>name<input id="username" type="text" autocomplete="on"></input></span>
        <label>password<input id="password" name="password" type="password" autocomplete="on"></input></label>
        <input type="submit">login</input>
      </form>

    </div>
  </body>


  <script>

    function submitToCloudant(fform)
    {
      try
      {
        testCouchDb(fform);
      }
      catch (e)
      {
        console.error('submitToCloudant(fform) failed:',e.name,';',e.message)
      }
    }


    function adminBasicAuthHeaderValue(username, userpassword)
    {
      //var retval = 'Basic ' + binb2b64(str2binb("test:" + "test"));
      var retval = 'Basic ' + binb2b64(str2binb(username + ":" + userpassword));
      return retval;
    }

    function testCouchDb(fform)
    {
      var name = fform.username.value,
          password = fform.password.value;

      var div1 = document.createElement("div");
      div1.id = "couchdb-alldbs";
      div2 = document.createElement("div");
      div2.id = "couchdb-cities";
      var parent = document.getElementById("couchdb-demo");
      parent.appendChild(div1);
      parent.appendChild(div2);

      CouchDB.urlPrefix= "http://data.321star.com";
      var req0 = CouchDB_login(name, password,
        function (req) {div2.innerHTML = div2.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.responseText + "</b>"},
        function () {
          allDbs(div2,
              function (req) {div1.innerHTML = div1.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.responseText + "</b>"}
            )
        });
    }

    function allDbs(div1,onSuccessFn,afterSuccessFn)
    {
      var xhr = CouchDB.newXhr();
      xhr.open("GET", CouchDB.urlPrefix + "/_all_dbs", true);
      xhr.withCredentials = true;
      xhr.onreadystatechange = function() {
        if (xhr.status == 201)
        {
            //console.log(xhr.getResponseHeader("location"));
            //console.log(xhr.getAllResponseHeaders());
        }
        if (xhr.readyState === 4)
        {
          if (xhr.status === 200)
          {
            //console.log(req2.responseText);
            //div1.innerHTML = div1.innerHTML + "<br/>http://amber.cloudant.com = <b>" + xhr.responseText + "</b>";
            if (onSuccessFn)
                onSuccessFn(xhr);
            if (afterSuccessFn)
                afterSuccessFn();
          } else
          {
            //alert(xhr.statusText);
            console.error(xhr.statusText);
          }
        }
      }
      xhr.send("");
    }

    function CouchDB_login(name, password, onSuccessFn, afterSuccessFn)
    {
      //      //{ "Authorization": adminBasicAuthHeaderValue() }
      var CouchDB_last_req = new CouchDB_request("POST", "/_session",
        {
          headers: {"Content-Type": "application/x-www-form-urlencoded",
            "X-CouchDB-WWW-Authenticate": "Cookie"},
          body: "name=" + encodeURIComponent(name) + "&password="
            + encodeURIComponent(password)
        },
        onSuccessFn, afterSuccessFn
      );
      /*
      var CouchDB_last_req = CouchDB_request("POST", "/_session", {
        headers: {
          "Authorization": adminBasicAuthHeaderValue(name, password)
          }
        });
      */
      ///return JSON.parse(CouchDB_last_req.responseText);

      return CouchDB_last_req;
    }

    CouchDB_request = function(method, uri, options, onSuccessFn, afterSuccessFn) {
      options = typeof(options) == 'object' ? options : {};
      options.headers = typeof(options.headers) == 'object' ? options.headers : {};
      options.headers["Content-Type"] = options.headers["Content-Type"] || options.headers["content-type"] || "application/json";
      options.headers["Accept"] = options.headers["Accept"] || options.headers["accept"] || "application/json";
      var req = CouchDB.newXhr();
      uri = CouchDB.proxyUrl(uri);
      req.open(method, uri, true);
      req.withCredentials = true;
      if (options.headers)
      {
        var headers = options.headers;
        for (var headerName in headers)
        {
          if (!headers.hasOwnProperty(headerName)) { continue; }
          req.setRequestHeader(headerName, headers[headerName]);
        }
      }
      ////////////////////////
      //req.onload = function() { alert("Connected!"); }
      req.onerror = function() { console.error("Not Connected to ", uri); }
      req.onreadystatechange = function() {
        if (req.status == 201) {
            //console.log(xhr.getResponseHeader("location"));
            console.log(req.getAllResponseHeaders());
        }
        if (req.readyState === 4) {
          //div2.innerHTML = "<b>" + adminBasicAuthHeaderValue(name,password) + "</b><br/>";
          if (req.status === 200) {
            //console.log(req2.responseText);
            //div2.innerHTML = div2.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.responseText + "</b>";
            if (onSuccessFn)
              onSuccessFn(req)
            //http://www.w3schools.com/js/js_function_invocation.asp
            if (afterSuccessFn)
              afterSuccessFn() // e.g. allDbs(div2)
          } else {
            //console.error(req2.statusText);
            div2.innerHTML = div2.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.statusText + "</b>";
          }
        }
      }
      ///////////////////////
      try
      {
        req.send(options.body || "");
      } catch (e)
      {
        alert("there was a problem communicating with the server");
        return;
      }
      return req;
    };
  </script>
</html>
