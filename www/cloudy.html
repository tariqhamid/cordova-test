<!DOCTYPE html>
<html>
  <head>
    <title>Cloudant-Test</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Tariq Hamid" />
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
    <script type='text/javascript' src='script/couch/couch.js'></script>
    <!-- c.f.
    /Users/tariq/SPA/FDA-demos/node_modules/hoodie-plugin-global-share/node_modules/hoodie-server/lib/utils/couch.js
    -->
    <script type='text/javascript' src='script/couch/sha1.js'></script>
  </head>
  <body>

    <div id="couchdb-demo" style="border: solid pink;background-color: #ff9">
      <div class="comment">
        Cloudant
      </div>
      <form onsubmit="submitToCloudant(this);return false" autocomplete="on">
        <label>name<input id="username" type="text" autocomplete="on"></input></span>
        <label>password<input id="password" name="password" type="password" autocomplete="on"></input></label>
        <input type="submit">login</input>
      </form>

    </div>
  </body>

  <script>

  //////////////////////////////////////////////////////////////////////////////
  /*
   * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
   * Digest Algorithm, as defined in RFC 1321.
   * Copyright (C) Paul Johnston 1999 - 2000.
   * Updated by Greg Holt 2000 - 2001.
   * See http://pajhome.org.uk/site/legal.html for details.
   */

  /*
   * Convert a 32-bit number to a hex string with ls-byte first
   */
  var hex_chr = "0123456789abcdef";
  function rhex(num)
  {
    str = "";
    for(j = 0; j <= 3; j++)
      str += hex_chr.charAt((num >> (j * 8 + 4)) & 0x0F) +
             hex_chr.charAt((num >> (j * 8)) & 0x0F);
    return str;
  }

  /*
   * Convert a string to a sequence of 16-word blocks, stored as an array.
   * Append padding bits and the length, as described in the MD5 standard.
   */
  function str2blks_MD5(str)
  {
    nblk = ((str.length + 8) >> 6) + 1;
    blks = new Array(nblk * 16);
    for(i = 0; i < nblk * 16; i++) blks[i] = 0;
    for(i = 0; i < str.length; i++)
      blks[i >> 2] |= str.charCodeAt(i) << ((i % 4) * 8);
    blks[i >> 2] |= 0x80 << ((i % 4) * 8);
    blks[nblk * 16 - 2] = str.length * 8;
    return blks;
  }

  /*
   * Add integers, wrapping at 2^32. This uses 16-bit operations internally
   * to work around bugs in some JS interpreters.
   */
  function add(x, y)
  {
    var lsw = (x & 0xFFFF) + (y & 0xFFFF);
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
    return (msw << 16) | (lsw & 0xFFFF);
  }

  /*
   * Bitwise rotate a 32-bit number to the left
   */
  function rol(num, cnt)
  {
    return (num << cnt) | (num >>> (32 - cnt));
  }

  /*
   * These functions implement the basic operation for each round of the
   * algorithm.
   */
  function cmn(q, a, b, x, s, t)
  {
    return add(rol(add(add(a, q), add(x, t)), s), b);
  }
  function ff(a, b, c, d, x, s, t)
  {
    return cmn((b & c) | ((~b) & d), a, b, x, s, t);
  }
  function gg(a, b, c, d, x, s, t)
  {
    return cmn((b & d) | (c & (~d)), a, b, x, s, t);
  }
  function hh(a, b, c, d, x, s, t)
  {
    return cmn(b ^ c ^ d, a, b, x, s, t);
  }
  function ii(a, b, c, d, x, s, t)
  {
    return cmn(c ^ (b | (~d)), a, b, x, s, t);
  }

  /*
   * Take a string and return the hex representation of its MD5.
   */
  function calcMD5(str)
  {
    x = str2blks_MD5(str);
    a =  1732584193;
    b = -271733879;
    c = -1732584194;
    d =  271733878;

    for(i = 0; i < x.length; i += 16)
    {
      olda = a;
      oldb = b;
      oldc = c;
      oldd = d;

      a = ff(a, b, c, d, x[i+ 0], 7 , -680876936);
      d = ff(d, a, b, c, x[i+ 1], 12, -389564586);
      c = ff(c, d, a, b, x[i+ 2], 17,  606105819);
      b = ff(b, c, d, a, x[i+ 3], 22, -1044525330);
      a = ff(a, b, c, d, x[i+ 4], 7 , -176418897);
      d = ff(d, a, b, c, x[i+ 5], 12,  1200080426);
      c = ff(c, d, a, b, x[i+ 6], 17, -1473231341);
      b = ff(b, c, d, a, x[i+ 7], 22, -45705983);
      a = ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
      d = ff(d, a, b, c, x[i+ 9], 12, -1958414417);
      c = ff(c, d, a, b, x[i+10], 17, -42063);
      b = ff(b, c, d, a, x[i+11], 22, -1990404162);
      a = ff(a, b, c, d, x[i+12], 7 ,  1804603682);
      d = ff(d, a, b, c, x[i+13], 12, -40341101);
      c = ff(c, d, a, b, x[i+14], 17, -1502002290);
      b = ff(b, c, d, a, x[i+15], 22,  1236535329);

      a = gg(a, b, c, d, x[i+ 1], 5 , -165796510);
      d = gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
      c = gg(c, d, a, b, x[i+11], 14,  643717713);
      b = gg(b, c, d, a, x[i+ 0], 20, -373897302);
      a = gg(a, b, c, d, x[i+ 5], 5 , -701558691);
      d = gg(d, a, b, c, x[i+10], 9 ,  38016083);
      c = gg(c, d, a, b, x[i+15], 14, -660478335);
      b = gg(b, c, d, a, x[i+ 4], 20, -405537848);
      a = gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
      d = gg(d, a, b, c, x[i+14], 9 , -1019803690);
      c = gg(c, d, a, b, x[i+ 3], 14, -187363961);
      b = gg(b, c, d, a, x[i+ 8], 20,  1163531501);
      a = gg(a, b, c, d, x[i+13], 5 , -1444681467);
      d = gg(d, a, b, c, x[i+ 2], 9 , -51403784);
      c = gg(c, d, a, b, x[i+ 7], 14,  1735328473);
      b = gg(b, c, d, a, x[i+12], 20, -1926607734);

      a = hh(a, b, c, d, x[i+ 5], 4 , -378558);
      d = hh(d, a, b, c, x[i+ 8], 11, -2022574463);
      c = hh(c, d, a, b, x[i+11], 16,  1839030562);
      b = hh(b, c, d, a, x[i+14], 23, -35309556);
      a = hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
      d = hh(d, a, b, c, x[i+ 4], 11,  1272893353);
      c = hh(c, d, a, b, x[i+ 7], 16, -155497632);
      b = hh(b, c, d, a, x[i+10], 23, -1094730640);
      a = hh(a, b, c, d, x[i+13], 4 ,  681279174);
      d = hh(d, a, b, c, x[i+ 0], 11, -358537222);
      c = hh(c, d, a, b, x[i+ 3], 16, -722521979);
      b = hh(b, c, d, a, x[i+ 6], 23,  76029189);
      a = hh(a, b, c, d, x[i+ 9], 4 , -640364487);
      d = hh(d, a, b, c, x[i+12], 11, -421815835);
      c = hh(c, d, a, b, x[i+15], 16,  530742520);
      b = hh(b, c, d, a, x[i+ 2], 23, -995338651);

      a = ii(a, b, c, d, x[i+ 0], 6 , -198630844);
      d = ii(d, a, b, c, x[i+ 7], 10,  1126891415);
      c = ii(c, d, a, b, x[i+14], 15, -1416354905);
      b = ii(b, c, d, a, x[i+ 5], 21, -57434055);
      a = ii(a, b, c, d, x[i+12], 6 ,  1700485571);
      d = ii(d, a, b, c, x[i+ 3], 10, -1894986606);
      c = ii(c, d, a, b, x[i+10], 15, -1051523);
      b = ii(b, c, d, a, x[i+ 1], 21, -2054922799);
      a = ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
      d = ii(d, a, b, c, x[i+15], 10, -30611744);
      c = ii(c, d, a, b, x[i+ 6], 15, -1560198380);
      b = ii(b, c, d, a, x[i+13], 21,  1309151649);
      a = ii(a, b, c, d, x[i+ 4], 6 , -145523070);
      d = ii(d, a, b, c, x[i+11], 10, -1120210379);
      c = ii(c, d, a, b, x[i+ 2], 15,  718787259);
      b = ii(b, c, d, a, x[i+ 9], 21, -343485551);

      a = add(a, olda);
      b = add(b, oldb);
      c = add(c, oldc);
      d = add(d, oldd);
    }
    return rhex(a) + rhex(b) + rhex(c) + rhex(d);
  }
  //////////////////////////////////////////////////////////////////////////////
  function sha1(str) {
    //  discuss at: http://phpjs.org/functions/sha1/
    // original by: Webtoolkit.info (http://www.webtoolkit.info/)
    // improved by: Michael White (http://getsprink.com)
    // improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    //    input by: Brett Zamir (http://brett-zamir.me)
    //   example 1: sha1('Kevin van Zonneveld');
    //   returns 1: '54916d2e62f65b3afa6e192e6a601cdbe5cb5897'

    var rotate_left = function(n, s) {
      var t4 = (n << s) | (n >>> (32 - s));
      return t4;
    };

    /*var lsb_hex = function (val) {
     // Not in use; needed?
      var str="";
      var i;
      var vh;
      var vl;

      for ( i=0; i<=6; i+=2 ) {
        vh = (val>>>(i*4+4))&0x0f;
        vl = (val>>>(i*4))&0x0f;
        str += vh.toString(16) + vl.toString(16);
      }
      return str;
    };*/

    var cvt_hex = function(val) {
      var str = '';
      var i;
      var v;

      for (i = 7; i >= 0; i--) {
        v = (val >>> (i * 4)) & 0x0f;
        str += v.toString(16);
      }
      return str;
    };

    var blockstart;
    var i, j;
    var W = new Array(80);
    var H0 = 0x67452301;
    var H1 = 0xEFCDAB89;
    var H2 = 0x98BADCFE;
    var H3 = 0x10325476;
    var H4 = 0xC3D2E1F0;
    var A, B, C, D, E;
    var temp;

    // utf8_encode
    str = unescape(encodeURIComponent(str));
    var str_len = str.length;

    var word_array = [];
    for (i = 0; i < str_len - 3; i += 4) {
      j = str.charCodeAt(i) << 24 | str.charCodeAt(i + 1) << 16 | str.charCodeAt(i + 2) << 8 | str.charCodeAt(i + 3);
      word_array.push(j);
    }

    switch (str_len % 4) {
    case 0:
      i = 0x080000000;
      break;
    case 1:
      i = str.charCodeAt(str_len - 1) << 24 | 0x0800000;
      break;
    case 2:
      i = str.charCodeAt(str_len - 2) << 24 | str.charCodeAt(str_len - 1) << 16 | 0x08000;
      break;
    case 3:
      i = str.charCodeAt(str_len - 3) << 24 | str.charCodeAt(str_len - 2) << 16 | str.charCodeAt(str_len - 1) <<
        8 | 0x80;
      break;
    }

    word_array.push(i);

    while ((word_array.length % 16) != 14) {
      word_array.push(0);
    }

    word_array.push(str_len >>> 29);
    word_array.push((str_len << 3) & 0x0ffffffff);

    for (blockstart = 0; blockstart < word_array.length; blockstart += 16) {
      for (i = 0; i < 16; i++) {
        W[i] = word_array[blockstart + i];
      }
      for (i = 16; i <= 79; i++) {
        W[i] = rotate_left(W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16], 1);
      }

      A = H0;
      B = H1;
      C = H2;
      D = H3;
      E = H4;

      for (i = 0; i <= 19; i++) {
        temp = (rotate_left(A, 5) + ((B & C) | (~B & D)) + E + W[i] + 0x5A827999) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotate_left(B, 30);
        B = A;
        A = temp;
      }

      for (i = 20; i <= 39; i++) {
        temp = (rotate_left(A, 5) + (B ^ C ^ D) + E + W[i] + 0x6ED9EBA1) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotate_left(B, 30);
        B = A;
        A = temp;
      }

      for (i = 40; i <= 59; i++) {
        temp = (rotate_left(A, 5) + ((B & C) | (B & D) | (C & D)) + E + W[i] + 0x8F1BBCDC) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotate_left(B, 30);
        B = A;
        A = temp;
      }

      for (i = 60; i <= 79; i++) {
        temp = (rotate_left(A, 5) + (B ^ C ^ D) + E + W[i] + 0xCA62C1D6) & 0x0ffffffff;
        E = D;
        D = C;
        C = rotate_left(B, 30);
        B = A;
        A = temp;
      }

      H0 = (H0 + A) & 0x0ffffffff;
      H1 = (H1 + B) & 0x0ffffffff;
      H2 = (H2 + C) & 0x0ffffffff;
      H3 = (H3 + D) & 0x0ffffffff;
      H4 = (H4 + E) & 0x0ffffffff;
    }

    temp = cvt_hex(H0) + cvt_hex(H1) + cvt_hex(H2) + cvt_hex(H3) + cvt_hex(H4);
    return temp.toLowerCase();
  }

  //////////////////////////////////////////////////////////////////////////////
  RequestQ =
  {
    xmlHttpReqQueue : [],
    result : null,
    wait : null,
    push: function (requestName, aRequest, insertAfter)
    {
      ///insertAfter = insertAfter || 0
      if (insertAfter)
      {
        for(var i=0; i < this.xmlHttpReqQueue.length; i++)
        {
          if (insertAfter == this.xmlHttpReqQueue[i][0])
          {
            this.xmlHttpReqQueue.splice(i+1,0,[requestName,aRequest])
            return
          }
        }
      }

      this.xmlHttpReqQueue.push([requestName,aRequest])
    },
    processQueue: function(result)
    {
        this.result = result
        var lastThread = this.xmlHttpReqQueue.shift()
        // process the next request if queue isn't empty
        if (this.xmlHttpReqQueue.length > 0)
        {
            console.log(this.xmlHttpReqQueue[0][0])
            this.xmlHttpReqQueue[0][1]()
        }
        else
        {
          if (this.wait)
          {
            var callbackFn = this.wait
            this.wait = null;
            callbackFn()
          }
        }
    },
    start: function()
    {
        if (this.xmlHttpReqQueue.length)
            this.xmlHttpReqQueue[0][1]()
    }
  }
  //////////////////////////////////////////////////////////////////////////////

  function adminBasicAuthHeaderValue(username, userpassword)
  {
    var retval = 'Basic ' + binb2b64(str2binb(username + ":" + userpassword))
    return retval
  }

  function allDbs(onSuccessFn,onErrorFn,isOnQueueFlag)
  {
    var xhr = CouchDB.newXhr()
    xhr.open("GET", CouchDB.urlPrefix + "/_all_dbs", true)
    xhr.onreadystatechange = function() {
      if (xhr.status == 201)
      {
          //console.log(xhr.getResponseHeader("location"))
          //console.log(xhr.getAllResponseHeaders())
      }
      if (xhr.readyState === 4)
      {
        if (xhr.status === 200)
        {
          if (onSuccessFn)
              onSuccessFn(xhr)
          if (isOnQueueFlag)
          {
            //RequestQ.processQueue()
          }
        } else
        {
          if (onErrorFn)
            onErrorFn(xhr)
          if (isOnQueueFlag)
          {
            //RequestQ.processQueue()
          }
        }
      }
    }
    xhr.send("")
  }

  function CouchDB_login(name, password, onSuccessFn, onErrorFn)
  {
    CouchDB.singletonXMLHttpRequest = null
    //      //{ "Authorization": adminBasicAuthHeaderValue() }
    var CouchDB_last_req = CouchDB_request("POST", "/_session",
      {
        headers: {"Content-Type": "application/x-www-form-urlencoded",
          "X-CouchDB-WWW-Authenticate": "Cookie"},
        body: "name=" + encodeURIComponent(name) + "&password="
          + encodeURIComponent(password)
      },
      onSuccessFn,
      onErrorFn,
      true
    )

    return CouchDB_last_req
  }

  /*
  CouchDB.logout = function() {
    CouchDB.last_req = CouchDB.request("DELETE", "/_session", {
      headers: {"Content-Type": "application/x-www-form-urlencoded",
        "X-CouchDB-WWW-Authenticate": "Cookie"}
    });
    return JSON.parse(CouchDB.last_req.responseText);
  };
  */

  function CouchDB_logout(onSuccessFn, onErrorFn)
  {
    //CouchDB.singletonXMLHttpRequest = null
    //      //{ "Authorization": adminBasicAuthHeaderValue() }
    var CouchDB_last_req = CouchDB_request("DELETE", "/_session",
      {
        headers: {"Content-Type": "application/x-www-form-urlencoded",
          "X-CouchDB-WWW-Authenticate": "Cookie"}
      },
      onSuccessFn,
      onErrorFn,
      true
    )

    return CouchDB_last_req
  }

  CouchDB_request = function(method, uri, options, onSuccessFn, onErrorFn,isOnQueueFlag) {
    options = typeof(options) == 'object' ? options : {}
    options.headers = typeof(options.headers) == 'object' ? options.headers : {}
    options.headers["Content-Type"] = options.headers["Content-Type"] || options.headers["content-type"] || "application/json"
    options.headers["Accept"] = options.headers["Accept"] || options.headers["accept"] || "application/json"
    var req = new CouchDB.newXhr()
    uri = CouchDB.proxyUrl(uri)
    req.open(method, uri, true)
    req.withCredentials = true
    if (options.headers)
    {
      var headers = options.headers
      for (var headerName in headers)
      {
        if (!headers.hasOwnProperty(headerName)) { continue }
        req.setRequestHeader(headerName, headers[headerName])
      }
    }
    req.onerror = function() { console.error("Not Connected to ", uri) }
    req.onreadystatechange = function() {
      if (req.status == 201) {
          //console.log(xhr.getResponseHeader("location"))
          //console.log(req.getAllResponseHeaders())
      }
      if (req.readyState === 4) {
        if (req.status === 200) {
          if (onSuccessFn)
            onSuccessFn(req)
          //if (isOnQueueFlag)
          //  RequestQ.processQueue()
        } else
        {
          if (onErrorFn)
            onErrorFn(req)
          //if (isOnQueueFlag)
          //  RequestQ.processQueue()
        }
      }
    }
    ///////////////////////
    try
    {
      req.send(options.body || "")
    } catch (e)
    {
      alert("there was a problem communicating with the server")
      return
    }

    return req
  }

  function createUser(name)
  {
    var parent = document.getElementById("couchdb-demo")

    var div = document.createElement("div")
    div.id = "createUser"
    parent.appendChild(div)

    RequestQ.push(
      "GET" + '/_users/' + name,
      function ()
      {
        var div = document.createElement("div")
        div.id = "createUser"
        parent.appendChild(div)

        CouchDB_request("GET",'/_users/org.couchdb.user:' + name, {body: "[]"},
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>A. http://alice@amber.cloudant.com = <b>" + req.responseText + "</b>"
            RequestQ.processQueue(req.responseText)
          },
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>B. http://alice@amber.cloudant.com = <b>" + req.statusText + "</b>"
            RequestQ.processQueue(req.responseText)
          }, true
        )
      }
    )
  }

  //////////////////////////////////////////////////////////////////////////////





  function submitToCloudant(fform)
  {
    try
    {
      testCouchDb(fform)
    }
    catch (e)
    {
      console.error('submitToCloudant(fform) failed:',e.name,';',e.message)
    }
  }

  function testCouchDb(fform)
  {
    var name = fform.username.value,
        password = fform.password.value

    div2 = document.createElement("div")
    div2.id = "couchdb-cities"
    var parent = document.getElementById("couchdb-demo")
    parent.appendChild(div2)

    CouchDB.urlPrefix= "http://data.confusedprogrammer.com"

    RequestQ.push(
      "login",
      function()
      {
        CouchDB_login(name, password,
          function (req)
          {
            div2.innerHTML = div2.innerHTML + "<br/>1. http://amber.cloudant.com = <b>" + req.responseText + "</b>"
            RequestQ.processQueue()
          },
          function (req)
          {
            div2.innerHTML = div2.innerHTML + "<br/>2. http://amber.cloudant.com = <b>" + req.statusText + "</b>"
            RequestQ.processQueue()
          }, true
        )
      }
    )

    RequestQ.push(
      "allDbs",
      function()
        {
          allDbs(function (req)
                   {
                      div2.innerHTML = div2.innerHTML + "<br/>3. http://amber.cloudant.com = <b>" + req.responseText + "</b>"
                      dbNamesString = req.responseText
                      // pop this current function off the queue and process the above multiple requests
                      RequestQ.processQueue()
                   },
                 function (req)
                   {
                      console.error(req.statusText)
                      div2.innerHTML = div2.innerHTML + "<br/> allDbs error "+req.statusText
                      // pop this current function off the queue and process the above multiple requests
                      RequestQ.processQueue()
                   },
                true
                )
        }
    )



    var dbNamesString = null
    var threadName = "multiple dbNames call"
    RequestQ.push(
      "multiple dbNames call",
      function()
        {
          var dbNames = JSON.parse(dbNamesString)
          dbNames.forEach(function callback(dbName) {
            var div = document.createElement("div")
            div.id = dbName
            parent.appendChild(div)

            RequestQ.push(
              "GET/" + dbName + "/_all_docs",
              function () {
                //console.log(name)
                // see apache-couchdb-1.6.1/share/www/script/test/basics.js
                xhr = CouchDB_request("GET", "/" + dbName + "/_all_docs?limit=50", {body: "[]"},
                        function (req)
                          {
                            div.innerHTML = div.innerHTML + "<br/><b>" + dbName + "</b>"
                            //console.log(name)

                            var items = JSON.parse(req.responseText)
                            div.innerHTML = div.innerHTML + "<br/>" + JSON.stringify(items)
                            items.rows.forEach(function callback(item)
                            {
                                div.innerHTML = div.innerHTML + "<br/>" + JSON.stringify(item)
                            })
                            RequestQ.processQueue()
                          },
                        function (req)
                          {
                            //console.error(req.statusText)
                            div.innerHTML = div.innerHTML + '<br/><p color="red">' + req.statusText + "</p>"
                            RequestQ.processQueue()
                          },
                        true
                        )
            }, threadName)
            threadName = "GET/" + dbName + "/_all_docs"
          }) // forEach

          RequestQ.processQueue()
        }
    )

    // CouchDB login for Cloudant https://www.grobmeier.de/couchdb-login-for-cloudant-23022016.html
    /*
    curl -X PUT -d '{
      "couchdb_auth_only": true
    }' "https://name:password@amber.cloudant.com/songblog/_security"
    */

    RequestQ.push(
      "PUT/songblog/_security",
      function () {
        var div = document.createElement("div")
        div.id = "security-put"
        parent.appendChild(div)
        xhr = CouchDB_request("PUT", "/songblog/_security", {body: '{"couchdb_auth_only": true}'},
                function (req)
                  {
                    div.innerHTML = div.innerHTML + "<br/><b>" + req.responseText + "</b>"
                    RequestQ.processQueue()
                  },
                function (req)
                  {
                    //console.error(req.statusText)
                    div.innerHTML = div.innerHTML + '<br/><p color="red">' + req.statusText + "</p>"
                    RequestQ.processQueue()
                  },
                true
                )
    })

    RequestQ.push(
      "GET/songblog/_security",
      function () {
        var div = document.createElement("div")
        div.id = "security-get"
        parent.appendChild(div)
        xhr = CouchDB_request("GET", "/songblog/_security", {body: '[]'},
                function (req)
                  {
                    div.innerHTML = div.innerHTML + "<br/><b>" + req.responseText + "</b>"
                    RequestQ.processQueue()
                  },
                function (req)
                  {
                    //console.error(req.statusText)
                    div.innerHTML = div.innerHTML + '<br/><p color="red">' + req.statusText + "</p>"
                    RequestQ.processQueue()
                  },
                true
                )
    })


  /*
    curl -X PUT -H "Content-Type: application/json" -d '{
    "password_sha": "329983971fc5dc8d157ccb10f2c0e71d5725cfff",
    "salt": "638769a280f1c46b18707e9db3edf844",
    "roles": ["my-role"],
    "type": "user"
  }' "https://name:password@amber.cloudant.com/_users/org.couchdb.user:test5"
  */
  /*
    curl -X POST https://amber.cloudant.com/_session -d 'name=test5&password=test4'
  */
    RequestQ.push(
      "login-test5",
      function()
      {
        var div = document.createElement("div")
        div.id = "login-test5"
        parent.appendChild(div)

        console.log('++ CouchDB_login as test5')
        CouchDB_login("test5", "test4",
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>1. http://test5@amber.cloudant.com = <b>" + req.responseText + "</b>"
            RequestQ.processQueue()
          },
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>2. http://test5@amber.cloudant.com = <b>" + req.statusText + "</b>"
            RequestQ.processQueue()
          }, true
        )
      }
    )


    // CouchDB_logout
    RequestQ.push(
      "logout-test5",
      function()
      {
        var div = document.createElement("div")
        div.id = "logout-test5"
        parent.appendChild(div)

        console.log('++ CouchDB_logout as test5')
        CouchDB_logout(
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>3. http://test5@amber.cloudant.com = <b>" + req.responseText + "</b>"
            RequestQ.processQueue()
          },
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>4. http://test5@amber.cloudant.com = <b>" + req.statusText + "</b>"
            RequestQ.processQueue()
          }, true
        )
      }
    )

    // trigger the first request in the queue
    RequestQ.start()



    RequestQ.push(
      "login-test7",
      function()
      {
        var div = document.createElement("div")
        div.id = "login-test7"
        parent.appendChild(div)

        console.log('++ CouchDB_login as test5')
        CouchDB_login(name, password,
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>7. http://amber@amber.cloudant.com = <b>" + req.responseText + "</b>"
            RequestQ.processQueue()
          },
          function (req)
          {
            div.innerHTML = div.innerHTML + "<br/>8. http://amber@amber.cloudant.com = <b>" + req.statusText + "</b>"
            RequestQ.processQueue()
          }, true
        )
      }
    )


    RequestQ.wait =
      function()
      {
        var name = 'alice'
        var password = '123'
        createUser('alice')
        RequestQ.wait =
          function()
          {
            console.log('finished ' + RequestQ.result)
            var err = JSON.parse(RequestQ.result)
            console.log(err)
            if (err && err.error === "not_found")
            {
              var hashAndSalt = generatePasswordHash2(password)
              db_save("/_users/" + "org.couchdb.user:" + name,
                JSON.stringify(
                  {
                    name: name,
                    password_sha: hashAndSalt[0],
                    salt: hashAndSalt[1],
                    password_scheme: 'simple',
                    type: 'user'
                  }
                )
              )
            }

          }
        RequestQ.start()
      }

  }


  function db_save(docPath, data)
  {

    RequestQ.push(
      "PUT/songblog/_security",
      function () {
        var div = document.createElement("div")
        div.id = "security-put"
        document.getElementById("couchdb-demo").appendChild(div)
        xhr = CouchDB_request("PUT", docPath, {body: data},
                function (req)
                  {
                    div.innerHTML = div.innerHTML + "<br/><b>" + req.responseText + "</b>"
                    RequestQ.processQueue()
                  },
                function (req)
                  {
                    //console.error(req.statusText)
                    div.innerHTML = div.innerHTML + '<br/><p color="red">' + req.statusText + "</p>"
                    RequestQ.processQueue()
                  },
                true
                )
    })

    RequestQ.start()
  }

//////////////////////////////////////////////////////////////////////////////
  function generatePasswordHash(password)
  {
    var salt = crypto.randomBytes(16).toString('hex');
    var hash = crypto.createHash('sha1');
    hash.update(password + salt);
    return [hash.digest('hex'), salt];
  }
  function generatePasswordHash2(password)
  {
    var randVal = rand()
    var salt = calcMD5(randVal)
    //var hash = hex_sha1("sha1")
    var result = sha1(password + salt)
    return [result, salt]
  }

  var rand = function() {
      return Math.random().toString(36).substr(2); // remove `0.`
  };

  var token = function() {
      return rand() + rand(); // to make it longer
  };
  //token();

//////////////////////////////////////////////////////////////////////////////

</script>
</html>
