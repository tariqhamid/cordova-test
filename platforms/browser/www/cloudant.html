<!DOCTYPE html>
<html>

  <head>
    <title>Cloudant-Test</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Tariq Hamid" />
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">


    <script type='text/javascript' src='script/couch/couch.js'></script>
    <script type='text/javascript' src='script/couch/sha1.js'></script>

  </head>

  <body>

    <div id="couchdb-demo" style="border: solid pink;background-color: #ff9;">
      <div class="comment">
        Cloudant
      </div>

      <form onsubmit="submitToCloudant(this);return false;" autocomplete="on">
        <label>name<input id="username" type="text" autocomplete="on"></input></span>
        <label>password<input id="password" name="password" type="password" autocomplete="on"></input></label>
        <input type="submit">login</input>
      </form>

    </div>

  </body>


  <script>

    function login(f){
        var username = f.username.value;
        var password = f.password.value;

        /* Make your validation and ajax magic here. */

        return false; //or the form will post your data to login.php
    }

    function submitToCloudant(fform)
    {

      try
      {
        testCouchDb(fform);
      }
      catch (e)
      {
        console.error('submitToCloudant(fform) failed:',e.name,';',e.message)
      }
      finally
      {

      }


    }


    function adminBasicAuthHeaderValue(username, userpassword) {
      //var retval = 'Basic ' + binb2b64(str2binb("test:" + "test"));
      var retval = 'Basic ' + binb2b64(str2binb(username + ":" + userpassword));
      return retval;
    }

    function testCouchDb(fform)
    {
      var name = fform.username.value,
          password = fform.password.value;

      var div1 = document.createElement("div");
      div1.id = "couchdb-alldbs";
      div2 = document.createElement("div");
      div2.id = "couchdb-cities";
      var parent = document.getElementById("couchdb-demo");
      parent.appendChild(div1);
      parent.appendChild(div2);


      if (window.Promise) {
        console.log('Promise found');

        var promise = new Promise(function(resolve, reject) {
          var request = new XMLHttpRequest();

          request.open('GET', 'http://api.icndb.com/jokes/random');
          request.onload = function() {
            if (request.status == 200) {
              resolve(request.response); // we got data here, so resolve the Promise
            } else {
              reject(Error(request.statusText)); // status is not 200 OK, so reject
            }
          };

          request.onerror = function() {
            reject(Error('Error fetching data.')); // error occurred, reject the  Promise
          };

          request.send(); //send the request
        });

        console.log('Asynchronous request made.');

        promise.then(function(data) {
          console.log('Got data! Promise fulfilled.');
          document.getElementsByTagName('body')[0].appendChild = JSON.parse(data).value.joke;
        }, function(error) {
          console.log('Promise rejected.');
          console.log(error.message);
        });
      } else {
        console.log('Promise not available');
      }



      CouchDB.urlPrefix= "http://data.321star.com";
      var req0 = CouchDB_login(name, password);



    }

    function allDbs(div1)
    {
      var xhr = CouchDB.newXhr();

      xhr.open("GET", CouchDB.urlPrefix + "/_all_dbs", true);
      xhr.withCredentials = true;

      xhr.onreadystatechange = function() {
        if (xhr.status == 201) {
            //console.log(xhr.getResponseHeader("location"));
            console.log(xhr.getAllResponseHeaders());
        }

        if (xhr.readyState === 4) {
          if (xhr.status === 200) {

            //console.log(req2.responseText);
            div1.innerHTML = div1.innerHTML + "<br/>http://amber.cloudant.com = <b>" + xhr.responseText + "</b>";

          } else {
            //alert(xhr.statusText);
            console.error(xhr.statusText);
          }
        }
      }
      xhr.send("");
    }

    function CouchDB_login(name, password)
    {
      //      //{ "Authorization": adminBasicAuthHeaderValue() }
      var CouchDB_last_req = CouchDB_request("POST", "/_session",
        {
          headers: {"Content-Type": "application/x-www-form-urlencoded",
            "X-CouchDB-WWW-Authenticate": "Cookie"},
          body: "name=" + encodeURIComponent(name) + "&password="
            + encodeURIComponent(password)
        },
        allDbs,[div2]
      );
      /*
      var CouchDB_last_req = CouchDB_request("POST", "/_session", {
        headers: {
          "Authorization": adminBasicAuthHeaderValue(name, password)
          }
        });
      */
      ///return JSON.parse(CouchDB_last_req.responseText);

      return CouchDB_last_req;
    }

    CouchDB_request = function(method, uri, options, nextFn, nextFnArgs) {
      options = typeof(options) == 'object' ? options : {};
      options.headers = typeof(options.headers) == 'object' ? options.headers : {};
      options.headers["Content-Type"] = options.headers["Content-Type"] || options.headers["content-type"] || "application/json";
      options.headers["Accept"] = options.headers["Accept"] || options.headers["accept"] || "application/json";
      var req = CouchDB.newXhr();
      uri = CouchDB.proxyUrl(uri);
      req.open(method, uri, true);
      req.withCredentials = true;
      if (options.headers) {
        var headers = options.headers;
        for (var headerName in headers) {
          if (!headers.hasOwnProperty(headerName)) { continue; }
          req.setRequestHeader(headerName, headers[headerName]);
        }
      }
      ////////////////////////

      req.onreadystatechange = function() {
        if (req.status == 201) {
            //console.log(xhr.getResponseHeader("location"));
            console.log(req.getAllResponseHeaders());
        }

        if (req.readyState === 4) {
          div2.innerHTML = "<b>" + adminBasicAuthHeaderValue(name,password) + "</b><br/>";
          if (req.status === 200) {

            //console.log(req2.responseText);
            div2.innerHTML = div2.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.responseText + "</b>";

            allDbs(div2)
            //http://www.w3schools.com/js/js_function_invocation.asp
            if (nextFn)
              nextFn.apply(null,nextFnArgs)


          } else {
            //console.error(req2.statusText);
            div2.innerHTML = div2.innerHTML + "<br/>http://amber.cloudant.com = <b>" + req.statusText + "</b>";
          }
        }
      }

      ///////////////////////

      req.send(options.body || "");
      return req;
    };


  </script>

</html>
